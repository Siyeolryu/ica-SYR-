name: Daily Stock Briefing

# ë§¤ì¼ í•œêµ­ì‹œê°„ ì˜¤ì „ 7ì‹œì— ì‹¤í–‰ (UTC 22:00 = KST 07:00)
on:
  schedule:
    - cron: '0 22 * * *'  # UTC 22:00 = KST 07:00 (ë‹¤ìŒë‚ )

  # ìˆ˜ë™ ì‹¤í–‰ ì˜µì…˜ (í…ŒìŠ¤íŠ¸ìš©)
  workflow_dispatch:

# ì´ìŠˆ/PR ìƒì„± ê¶Œí•œ ì„¤ì •
permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  generate-and-send-briefing:
    runs-on: ubuntu-latest

    steps:
      # 1. ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Python 3.12 í™˜ê²½ ì„¤ì •
      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'  # pip ìºì‹œ í™œì„±í™”

      # 3. ì˜ì¡´ì„± ì„¤ì¹˜
      - name: Install dependencies
        run: |
          cd backend
          pip install --upgrade pip
          pip install -r requirements.txt

      # 4. í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
      - name: Set up environment variables
        run: |
          cd backend
          echo "GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}" >> .env
          echo "EXA_API_KEY=${{ secrets.EXA_API_KEY }}" >> .env
          echo "SLACK_WEBHOOK_URL=${{ secrets.SLACK_WEBHOOK_URL }}" >> .env
          echo "EMAIL_SMTP_SERVER=${{ secrets.EMAIL_SMTP_SERVER }}" >> .env
          echo "EMAIL_SMTP_PORT=${{ secrets.EMAIL_SMTP_PORT }}" >> .env
          echo "EMAIL_SENDER=${{ secrets.EMAIL_SENDER }}" >> .env
          echo "EMAIL_PASSWORD=${{ secrets.EMAIL_PASSWORD }}" >> .env
          echo "EMAIL_RECIPIENTS=${{ secrets.EMAIL_RECIPIENTS }}" >> .env

      # 5. í™”ì œ ì¢…ëª© ì¡°íšŒ
      - name: Get trending stocks
        id: trending
        run: |
          cd backend
          python -c "
          import sys
          sys.path.insert(0, '.')
          from services.trending_stock_service import TrendingStockService

          # í™”ì œ ì¢…ëª© ì¡°íšŒ
          result = TrendingStockService.get_trending_stocks(
              screener_types=['most_actives', 'day_gainers'],
              count=5
          )

          print('âœ“ í™”ì œ ì¢…ëª© ì¡°íšŒ ì™„ë£Œ')
          print(f'ì¡°íšŒëœ ì¢…ëª© ìˆ˜: {len(result.get(\"stocks\", []))}')

          # ê²°ê³¼ë¥¼ í™˜ê²½ ë³€ìˆ˜ë¡œ ì €ì¥
          with open('$GITHUB_ENV', 'a') as f:
              f.write(f'STOCK_COUNT={len(result.get(\"stocks\", []))}\n')
          "

      # 6. ë¸Œë¦¬í•‘ ìƒì„±
      - name: Generate briefing
        id: briefing
        run: |
          cd backend
          python -c "
          import sys
          import os
          from datetime import datetime
          sys.path.insert(0, '.')

          # ë¸Œë¦¬í•‘ ìƒì„± ë¡œì§
          print('ë¸Œë¦¬í•‘ ìƒì„± ì¤‘...')

          # daily_briefing_workflow.py ì‹¤í–‰
          from daily_briefing_workflow import main as run_daily_briefing

          result = run_daily_briefing()

          if result.get('success'):
              print('âœ“ ë¸Œë¦¬í•‘ ìƒì„± ì™„ë£Œ')
              briefing_id = result.get('briefing_id', 'N/A')
              print(f'ìƒì„±ëœ ë¸Œë¦¬í•‘ ID: {briefing_id}')

              # ê²°ê³¼ë¥¼ í™˜ê²½ ë³€ìˆ˜ë¡œ ì €ì¥
              with open('$GITHUB_ENV', 'a') as f:
                  f.write(f'BRIEFING_ID={briefing_id}\n')
                  f.write(f'BRIEFING_SUCCESS=true\n')
          else:
              print('âœ— ë¸Œë¦¬í•‘ ìƒì„± ì‹¤íŒ¨')
              with open('$GITHUB_ENV', 'a') as f:
                  f.write(f'BRIEFING_SUCCESS=false\n')
              sys.exit(1)
          "

      # 7. ë¸Œë¦¬í•‘ ë°œì†¡ (Slack + Email)
      - name: Send briefing
        id: send
        run: |
          cd backend
          python -c "
          import sys
          import os
          sys.path.insert(0, '.')

          from send_briefing import send_to_slack, send_to_email

          slack_success = False
          email_success = False

          # Slack ë°œì†¡
          try:
              slack_result = send_to_slack()
              if slack_result:
                  print('âœ“ Slack ë°œì†¡ ì™„ë£Œ')
                  slack_success = True
              else:
                  print('âš  Slack ë°œì†¡ ì‹¤íŒ¨')
          except Exception as e:
              print(f'âš  Slack ë°œì†¡ ì˜¤ë¥˜: {str(e)}')

          # Email ë°œì†¡
          try:
              email_result = send_to_email()
              if email_result:
                  print('âœ“ Email ë°œì†¡ ì™„ë£Œ')
                  email_success = True
              else:
                  print('âš  Email ë°œì†¡ ì‹¤íŒ¨')
          except Exception as e:
              print(f'âš  Email ë°œì†¡ ì˜¤ë¥˜: {str(e)}')

          # ê²°ê³¼ ì €ì¥
          with open('$GITHUB_ENV', 'a') as f:
              f.write(f'SLACK_SUCCESS={slack_success}\n')
              f.write(f'EMAIL_SUCCESS={email_success}\n')
          "

      # 8. ìƒì„±ëœ íŒŒì¼ ì—…ë¡œë“œ (ì•„í‹°íŒ©íŠ¸)
      - name: Upload briefing artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: briefing-${{ github.run_number }}-${{ github.run_attempt }}
          path: |
            backend/output/**/*.png
            backend/output/**/*.json
            backend/output/**/*.txt
            backend/output/**/*.pdf
            backend/output/**/*.docx
            backend/output/**/*.xlsx
          retention-days: 7
          if-no-files-found: warn

      # 9. ì‹¤í–‰ ê²°ê³¼ ìš”ì•½ ìƒì„±
      - name: Generate summary
        if: always()
        run: |
          echo "## ğŸ“Š Daily Briefing ì‹¤í–‰ ê²°ê³¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ì‹¤í–‰ ì‹œê°„**: $(date +'%Y-%m-%d %H:%M:%S KST')" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow Run**: #${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ job.status }}" == "success" ]; then
            echo "### âœ… ì„±ê³µ" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- ì¡°íšŒëœ ì¢…ëª© ìˆ˜: ${STOCK_COUNT:-N/A}" >> $GITHUB_STEP_SUMMARY
            echo "- ë¸Œë¦¬í•‘ ID: ${BRIEFING_ID:-N/A}" >> $GITHUB_STEP_SUMMARY
            echo "- Slack ë°œì†¡: ${SLACK_SUCCESS:-false}" >> $GITHUB_STEP_SUMMARY
            echo "- Email ë°œì†¡: ${EMAIL_SUCCESS:-false}" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ ì‹¤íŒ¨" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ì•„í‹°íŒ©íŠ¸**: [briefing-${{ github.run_number }}-${{ github.run_attempt }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY

      # 10. ì‹¤íŒ¨ ì‹œ Slack ì•Œë¦¼
      - name: Notify failure to Slack
        if: failure() && secrets.SLACK_WEBHOOK_URL != ''
        run: |
          curl -X POST ${{ secrets.SLACK_WEBHOOK_URL }} \
            -H 'Content-Type: application/json' \
            -d '{
              "text": "âš ï¸ Daily Stock Briefing ìƒì„± ì‹¤íŒ¨!",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "âš ï¸ Daily Stock Briefing ì‹¤íŒ¨"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*ì‹¤í–‰ ì‹œê°„:*\n'"$(date +'%Y-%m-%d %H:%M:%S KST')"'"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Workflow:*\n<https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|#${{ github.run_number }}>"
                    }
                  ]
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ìœ„ ë§í¬ì—ì„œ ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”."
                  }
                }
              ]
            }'

      # 11. ì‹¤í–‰ ê²°ê³¼ ì´ìŠˆ ìƒì„±
      - name: Create issue with results
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const today = new Date().toISOString().split('T')[0];
            const runNumber = context.runNumber;
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;

            const stockCount = process.env.STOCK_COUNT || 'N/A';
            const briefingId = process.env.BRIEFING_ID || 'N/A';
            const slackSuccess = process.env.SLACK_SUCCESS === 'true' ? 'âœ…' : 'âŒ';
            const emailSuccess = process.env.EMAIL_SUCCESS === 'true' ? 'âœ…' : 'âŒ';
            const jobStatus = '${{ job.status }}';

            const statusEmoji = jobStatus === 'success' ? 'âœ…' : 'âŒ';
            const statusText = jobStatus === 'success' ? 'ì„±ê³µ' : 'ì‹¤íŒ¨';

            const issueTitle = `[Daily Briefing] ${today} - ${statusText}`;
            const issueBody = `## ğŸ“Š Daily Stock Briefing ì‹¤í–‰ ê²°ê³¼

**ì‹¤í–‰ ì‹œê°„**: ${today}
**ìƒíƒœ**: ${statusEmoji} ${statusText}
**Workflow Run**: [#${runNumber}](${runUrl})

---

### ğŸ“ˆ ì‹¤í–‰ ìƒì„¸

- **ì¡°íšŒëœ ì¢…ëª© ìˆ˜**: ${stockCount}
- **ë¸Œë¦¬í•‘ ID**: ${briefingId}
- **Slack ë°œì†¡**: ${slackSuccess}
- **Email ë°œì†¡**: ${emailSuccess}

---

### ğŸ“ ì•„í‹°íŒ©íŠ¸

ìƒì„±ëœ ë¸Œë¦¬í•‘ íŒŒì¼ì€ [Artifacts](${runUrl}#artifacts)ì—ì„œ ë‹¤ìš´ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
- ë³´ê´€ ê¸°ê°„: 7ì¼
- íŒŒì¼ëª…: \`briefing-${runNumber}-${{ github.run_attempt }}\`

---

### ğŸ”— ë§í¬

- [Workflow ë¡œê·¸ ë³´ê¸°](${runUrl})
- [ì €ì¥ì†Œ Actions](https://github.com/${context.repo.owner}/${context.repo.repo}/actions)

---

*ì´ ì´ìŠˆëŠ” GitHub Actionsì— ì˜í•´ ìë™ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.*
`;

            // ì´ìŠˆ ìƒì„±
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: issueTitle,
              body: issueBody,
              labels: ['automated', 'daily-briefing', jobStatus === 'success' ? 'success' : 'failure']
            });

      # 12. ìµœì¢… ìƒíƒœ ì¶œë ¥
      - name: Final status
        if: always()
        run: |
          echo "========================================="
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… ì¼ì¼ ë¸Œë¦¬í•‘ ì›Œí¬í”Œë¡œìš° ì™„ë£Œ"
            echo "========================================="
            echo ""
            echo "ğŸ“Š ì‹¤í–‰ ê²°ê³¼:"
            echo "  - ì¢…ëª© ìˆ˜: ${STOCK_COUNT:-N/A}"
            echo "  - ë¸Œë¦¬í•‘ ID: ${BRIEFING_ID:-N/A}"
            echo "  - Slack: ${SLACK_SUCCESS:-false}"
            echo "  - Email: ${EMAIL_SUCCESS:-false}"
          else
            echo "âŒ ì¼ì¼ ë¸Œë¦¬í•‘ ì›Œí¬í”Œë¡œìš° ì‹¤íŒ¨"
            echo "========================================="
            echo ""
            echo "ë¡œê·¸ë¥¼ í™•ì¸í•˜ì—¬ ë¬¸ì œë¥¼ í•´ê²°í•˜ì„¸ìš”."
          fi
          echo ""
