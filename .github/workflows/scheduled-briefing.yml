name: Scheduled Briefing Generation

on:
  schedule:
    # 한국 시간(KST) 19:00에 실행
    # UTC 시간으로 변환: KST = UTC + 9
    # 19:00 KST = 10:00 UTC
    
    # 매주 월/수/금 19:00 (KST) = 10:00 UTC
    # 4주간 실행 (총 12회)
    - cron: '0 10 * * 1,3,5'  # 월요일, 수요일, 금요일
  
  # 수동 실행도 가능하도록
  workflow_dispatch:

# 모든 권한 부여
permissions:
  contents: write
  actions: write
  issues: write
  pull-requests: write

jobs:
  generate-briefing:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'
          cache-dependency-path: 'backend/requirements.txt'
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential
      
      - name: Install Python dependencies
        working-directory: ./backend
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install --no-cache-dir -r requirements.txt
      
      - name: Verify Python environment
        working-directory: ./backend
        run: |
          python --version
          pip list
          echo "PYTHONPATH: $PWD"
          ls -la
      
      - name: Set up environment variables
        working-directory: ./backend
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          EXA_API_KEY: ${{ secrets.EXA_API_KEY }}
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          # .env 파일 생성
          if [ -n "$GEMINI_API_KEY" ]; then
            echo "GEMINI_API_KEY=$GEMINI_API_KEY" > .env
          fi
          if [ -n "$EXA_API_KEY" ]; then
            echo "EXA_API_KEY=$EXA_API_KEY" >> .env
          fi
          if [ -n "$SLACK_WEBHOOK_URL" ]; then
            echo "SLACK_WEBHOOK_URL=$SLACK_WEBHOOK_URL" >> .env
          fi
          echo "Environment variables set"
          cat .env | sed 's/\(.*=\).*/\1***/' || echo "No .env file"
      
      - name: Test imports
        working-directory: ./backend
        env:
          PYTHONPATH: ${{ github.workspace }}/backend
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          EXA_API_KEY: ${{ secrets.EXA_API_KEY }}
        run: |
          echo "Testing imports..."
          python -c "
          import sys
          sys.path.insert(0, '.')
          try:
              from get_trending_stocks import get_top_trending_stock
              print('[OK] get_trending_stocks import successful')
          except Exception as e:
              print(f'[FAIL] get_trending_stocks import failed: {e}')
              sys.exit(1)
          
          try:
              from exa_news import search_stock_news
              print('[OK] exa_news import successful')
          except Exception as e:
              print(f'[FAIL] exa_news import failed: {e}')
              sys.exit(1)
          
          try:
              from gemini_briefing import generate_briefing_text
              print('[OK] gemini_briefing import successful')
          except Exception as e:
              print(f'[FAIL] gemini_briefing import failed: {e}')
              sys.exit(1)
          
          try:
              from daily_briefing_workflow import run_daily_briefing_workflow
              print('[OK] daily_briefing_workflow import successful')
          except Exception as e:
              print(f'[FAIL] daily_briefing_workflow import failed: {e}')
              import traceback
              traceback.print_exc()
              sys.exit(1)
          
          print('All imports successful!')
          "
      
      - name: Run briefing workflow
        working-directory: ./backend
        env:
          PYTHONPATH: ${{ github.workspace }}/backend
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          EXA_API_KEY: ${{ secrets.EXA_API_KEY }}
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          echo "=========================================="
          echo "브리핑 워크플로우 실행 시작"
          echo "실행 시간: $(date '+%Y-%m-%d %H:%M:%S UTC')"
          echo "=========================================="
          
          python -c "
          import sys
          import os
          import json
          import traceback
          
          # PYTHONPATH 설정
          sys.path.insert(0, os.getcwd())
          
          try:
              from daily_briefing_workflow import run_daily_briefing_workflow
              
              config = {
                  'email_recipients': [],
                  'slack_channels': []
              }
              
              print('워크플로우 실행 중...')
              result = run_daily_briefing_workflow(config)
              
              print('\n==========================================')
              print('실행 결과')
              print('==========================================')
              print(f'성공: {result[\"success\"]}')
              print(f'완료된 단계: {result[\"steps_completed\"]}')
              
              if result.get('steps_failed'):
                  print(f'실패한 단계: {result[\"steps_failed\"]}')
              
              if result.get('error'):
                  print(f'오류: {result[\"error\"]}')
                  sys.exit(1)
              
              if result.get('stock_data'):
                  print(f'선정된 종목: {result[\"stock_data\"].get(\"symbol\", \"N/A\")}')
              
              if not result['success']:
                  print('워크플로우가 실패했습니다.')
                  sys.exit(1)
              
              print('워크플로우 성공적으로 완료되었습니다!')
              
          except ImportError as e:
              print(f'Import 오류: {e}')
              traceback.print_exc()
              sys.exit(1)
          except Exception as e:
              print(f'실행 오류: {e}')
              traceback.print_exc()
              sys.exit(1)
          "
      
      - name: Upload output files
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: briefing-output-${{ github.run_number }}
          path: |
            backend/output/**/*
          retention-days: 7
          if-no-files-found: ignore
      
      - name: Create summary
        if: always()
        run: |
          echo "## 브리핑 생성 결과" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- 실행 시간: $(date '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "- 워크플로우: ${{ github.workflow }}" >> $GITHUB_STEP_SUMMARY
          echo "- 실행 번호: ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "- 커밋: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
