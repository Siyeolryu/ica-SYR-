# 개발일지: 자동화 워크플로우 구현

## 작성시각
2024년 1월 15일

## 해결하고자 한 문제

목표 워크플로우를 완전히 자동화하기 위해 다음 기능들이 필요했습니다:

1. **매일 아침 7시 자동 실행**: 스케줄러를 사용하여 정해진 시간에 자동으로 워크플로우 실행
2. **브리핑 이미지 생성**: Gemini API를 사용하여 텍스트 브리핑을 이미지로 변환
3. **자동 발송 시스템**: 이메일/슬랙으로 브리핑 자동 발송 (샘플 구현)
4. **통합 워크플로우**: 모든 단계를 연결하는 메인 스크립트
5. **종목 분석 강화**: 왜 화제인지 분석하는 기능 추가

## 해결된 것

### 1. 스케줄러 구현 (APScheduler 사용)
- **파일**: `backend/scheduler.py`
- **기능**:
  - APScheduler를 사용하여 매일 아침 7시에 자동 실행
  - 한국 시간대(Asia/Seoul) 지원
  - 즉시 실행 모드 제공 (테스트용)
  - 작업 실행 이벤트 리스너로 로깅 및 에러 처리
- **사용법**:
  ```bash
  # 스케줄러 시작 (매일 7시 실행)
  python backend/scheduler.py
  
  # 즉시 실행 (테스트용)
  python backend/scheduler.py --run-once
  
  # 커스텀 시간 설정
  python backend/scheduler.py --hour 8 --minute 30
  ```

### 2. 브리핑 이미지 생성 기능 추가
- **파일**: `backend/gemini_briefing.py`
- **기능**:
  - `generate_briefing_image()`: 브리핑 텍스트를 이미지로 생성
  - `generate_briefing_image_with_pillow()`: Pillow를 사용한 이미지 렌더링
  - 텍스트 브리핑을 시각적으로 아름다운 이미지로 변환
  - 제목, 요약, 종목 정보, 섹션 내용을 포함한 이미지 생성
- **특징**:
  - Gemini API의 이미지 생성 기능 시도 후 Pillow로 fallback
  - PNG 형식으로 저장
  - base64 인코딩 지원

### 3. 자동 발송 시스템 (샘플 구현)
- **파일**: `backend/send_briefing.py`
- **기능**:
  - `send_email_briefing()`: 이메일 발송 함수 (샘플)
  - `send_slack_briefing()`: 슬랙 발송 함수 (샘플)
  - `send_briefing_to_channels()`: 여러 채널로 일괄 발송
- **특징**:
  - 실제 발송 기능은 구현하지 않고 구조만 제공
  - 주석으로 실제 구현 예시 코드 포함
  - 환경 변수로 설정 관리 (EMAIL_SMTP_SERVER, SLACK_WEBHOOK_URL 등)

### 4. 통합 워크플로우 스크립트
- **파일**: `backend/daily_briefing_workflow.py`
- **기능**:
  - `step1_collect_trending_stocks()`: 화제 종목 수집 및 TOP 1 선정
  - `step2_collect_stock_info()`: 종목 정보 수집 (뉴스, 분석 등)
  - `step3_generate_briefing()`: 브리핑 콘텐츠 생성 (텍스트 + 이미지)
  - `step4_send_briefing()`: 브리핑 자동 발송
  - `run_daily_briefing_workflow()`: 전체 워크플로우 실행
- **특징**:
  - 각 단계별 로깅 및 에러 처리
  - 브리핑 데이터를 JSON 파일로 저장
  - 실행 결과를 딕셔너리로 반환

### 5. 종목 분석 로직 강화
- **파일**: `backend/gemini_briefing.py`
- **기능**:
  - `analyze_why_trending()`: 종목이 왜 화제인지 분석
  - 뉴스 기사와 종목 데이터를 종합하여 화제 원인 분석
  - Gemini API를 사용한 AI 기반 분석
- **특징**:
  - 뉴스 내용, 가격 변동, 거래량을 종합하여 분석
  - 3-5문장으로 핵심 원인 설명

### 6. requirements.txt 업데이트
- APScheduler>=3.10.4 추가
- Pillow>=10.0.0 추가 (이미지 생성용)

## 해결되지 않은 것

1. **실제 이메일/슬랙 발송 기능**
   - 현재는 샘플 코드만 제공
   - 실제 발송을 위해서는 SMTP 서버 설정 또는 Slack Bot Token 필요
   - 향후 실제 발송 기능 구현 필요

2. **Gemini API 이미지 생성**
   - Gemini API의 직접적인 이미지 생성 기능은 제한적
   - 현재는 Pillow를 사용한 텍스트 렌더링 방식 사용
   - 향후 Gemini의 이미지 생성 기능이 개선되면 업데이트 필요

3. **에러 복구 메커니즘**
   - API 호출 실패 시 재시도 로직 미구현
   - 네트워크 오류 시 자동 복구 기능 없음

4. **데이터베이스 저장**
   - 현재는 JSON 파일로만 저장
   - 향후 데이터베이스 연동 필요 (히스토리 관리 등)

## 향후 개발을 위한 컨텍스트

### 전체 워크플로우 구조

```
매일 아침 7시 (스케줄러)
    ↓
1. 화제 종목 수집 (get_trending_stocks.py)
    - Yahoo Finance Screener 사용
    - TOP 1 종목 선정
    ↓
2. 종목 정보 수집 (exa_news.py, gemini_briefing.py)
    - 회사 기본 정보 (yahooquery)
    - 관련 뉴스 요약 (Exa API)
    - 왜 화제인지 분석 (Gemini API)
    ↓
3. 브리핑 콘텐츠 생성 (gemini_briefing.py)
    - 텍스트: Gemini API
    - 이미지: Pillow (텍스트 → 이미지)
    ↓
4. 자동 발송 (send_briefing.py)
    - 이메일/슬랙 발송 (샘플)
    ↓
5. 데이터 저장
    - JSON 파일로 저장 (output 폴더)
```

### 주요 파일 구조

```
backend/
├── get_trending_stocks.py      # 화제 종목 수집
├── exa_news.py                 # 뉴스 수집 및 요약
├── gemini_briefing.py          # 브리핑 생성 (텍스트 + 이미지)
├── send_briefing.py            # 자동 발송 (샘플)
├── daily_briefing_workflow.py  # 통합 워크플로우
├── scheduler.py                # 스케줄러
└── output/                     # 생성된 브리핑 저장 폴더
    ├── briefing_*.json         # 브리핑 데이터
    └── briefing_*.png           # 브리핑 이미지
```

### 환경 변수 설정

`.env` 파일에 다음 변수들을 설정해야 합니다:

```env
# Gemini API
GEMINI_API_KEY=your_gemini_api_key

# Exa API
EXA_API_KEY=your_exa_api_key

# 이메일 발송 (선택)
EMAIL_SMTP_SERVER=smtp.gmail.com
EMAIL_SMTP_PORT=587
EMAIL_USERNAME=your_email@gmail.com
EMAIL_PASSWORD=your_password

# 슬랙 발송 (선택)
SLACK_WEBHOOK_URL=https://hooks.slack.com/services/XXX/YYY/ZZZ
```

### 실행 방법

1. **의존성 설치**:
   ```bash
   pip install -r backend/requirements.txt
   ```

2. **환경 변수 설정**:
   - `backend/.env` 파일 생성 및 API 키 설정

3. **스케줄러 시작**:
   ```bash
   python backend/scheduler.py
   ```

4. **즉시 실행 (테스트)**:
   ```bash
   python backend/scheduler.py --run-once
   ```

5. **워크플로우 직접 실행**:
   ```bash
   python backend/daily_briefing_workflow.py
   ```

### 기술 스택

- **스케줄러**: APScheduler 3.10.4+
- **이미지 생성**: Pillow 10.0.0+
- **AI 생성**: Google Gemini API
- **뉴스 검색**: Exa API
- **종목 데이터**: Yahoo Finance (yahooquery)

### 다음 단계 개발 우선순위

1. **실제 발송 기능 구현** (중요도: 높음)
   - 이메일 발송: SMTP 서버 연동
   - 슬랙 발송: Slack Webhook 또는 Bot API 연동

2. **에러 처리 강화** (중요도: 높음)
   - API 호출 재시도 로직
   - 네트워크 오류 복구
   - 부분 실패 시 재시도

3. **데이터베이스 연동** (중요도: 중간)
   - 브리핑 히스토리 저장
   - 사용자 설정 관리
   - 발송 로그 저장

4. **모니터링 및 알림** (중요도: 중간)
   - 워크플로우 실행 상태 모니터링
   - 실패 시 알림 발송
   - 성능 메트릭 수집

5. **이미지 생성 개선** (중요도: 낮음)
   - 더 나은 디자인 템플릿
   - 차트/그래프 포함
   - 브랜딩 요소 추가

### 참고사항

- 스케줄러는 BlockingScheduler를 사용하므로 별도 프로세스로 실행해야 합니다
- 프로덕션 환경에서는 systemd, supervisor 등으로 프로세스 관리 권장
- API 키는 반드시 환경 변수로 관리하고 버전 관리에 포함하지 않아야 합니다
- 이미지 생성 시 폰트 파일이 없으면 기본 폰트를 사용하므로, 한글 폰트 설치 권장

### 쉽게 설명하면

이번 개발은 "자동화된 뉴스레터 시스템"을 만든 것과 같습니다:
- **기존**: 수동으로 종목을 찾고, 뉴스를 읽고, 브리핑을 작성해야 했음
- **새로운**: 매일 아침 7시에 자동으로 화제 종목을 찾고, 뉴스를 수집하고, AI가 브리핑을 작성하고, 이미지를 생성하고, 발송까지 자동으로 처리

이제 사람이 개입하지 않아도 매일 아침 자동으로 브리핑이 생성되고 발송됩니다!

